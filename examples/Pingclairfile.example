# ðŸ¦€ Pingclair é…ç½®æ–‡ä»¶ç¤ºä¾‹
# ---------------------------------------------------
# æ­¤æ–‡ä»¶å±•ç¤ºäº† Pingclair çš„æ ¸å¿ƒåŠŸèƒ½ä¸Žè¯­æ³•ã€‚
# è¯­æ³•çµæ„Ÿæ¥æºäºŽ Caddy å’Œ Rustï¼Œç®€å•ç›´è§‚ã€‚

# âš¡ï¸ å…¨å±€é…ç½® (å¯é€‰)
debug: false

# ðŸ  è™šæ‹Ÿä¸»æœº 1: é™æ€æ–‡ä»¶æœåŠ¡ + è‡ªåŠ¨ HTTPS
server "example.com" {
    # ç›‘å¬åœ°å€ (æ”¯æŒ IPv4/IPv6)
    listen: "0.0.0.0:443";
    listen: "[::]:443";

    # ðŸ” è‡ªåŠ¨ HTTPS (é€šè¿‡ Let's Encrypt / ZeroSSL)
    # åªéœ€ä¸€è¡Œï¼Œè‡ªåŠ¨ç”³è¯·ã€ç»­æœŸå¹¶é…ç½®è¯ä¹¦ã€‚
    tls auto;

    # ðŸ›¤ è·¯ç”±å—
    route {
        # 1. åŒ¹é…ç‰¹å®šè·¯å¾„å¹¶é‡å†™
        match path("/old-api/*") => {
            rewrite "/old-api/(.*)" "/new-api/$1";
        }

        # 2. é™æ€æ–‡ä»¶æœåŠ¡
        match path("/static/*") => {
            file_server "./public";
        }

        # 3. å…œåº•å¤„ç† (Catch-all)
        _ => {
            file_server "./public/index.html";
        }
    }
}

# ðŸ”„ è™šæ‹Ÿä¸»æœº 2: åå‘ä»£ç† + è´Ÿè½½å‡è¡¡ + é€ŸçŽ‡é™åˆ¶
server "api.example.com" {
    listen: "0.0.0.0:80";

    route {
        match path("/v1/*") => {
            # ðŸš¦ é€ŸçŽ‡é™åˆ¶ (10ç§’å†…æœ€å¤š100ä¸ªè¯·æ±‚)
            rate_limit {
                requests: 100;
                window: "10s";
            }

            # ðŸš€ é«˜æ€§èƒ½åå‘ä»£ç†
            proxy {
                # ä¸Šæ¸¸æœåŠ¡å™¨åˆ—è¡¨
                to "localhost:8080";
                to "localhost:8081";

                # è´Ÿè½½å‡è¡¡ç­–ç•¥: round_robin (é»˜è®¤), random, least_conn, ip_hash
                load_balance {
                    strategy: "round_robin";
                }

                # å¥åº·æ£€æŸ¥ (æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡)
                health_check {
                    path: "/health";
                    interval: "5s";
                }
            }
        }

        # 404 è‡ªå®šä¹‰è¿”å›ž
        _ => {
            respond 404 {
                body: "API Endpoint Not Found";
                header: "X-Server" "Pingclair";
            }
        }
    }
}

# ðŸŒŽ è™šæ‹Ÿä¸»æœº 3: é»˜è®¤æœåŠ¡å™¨ (é€šé…ç¬¦)
# åŒ¹é…æ‰€æœ‰æœªè¢«å…¶ä»– server å—æ•èŽ·çš„åŸŸå
server "_" {
    listen: "0.0.0.0:80";

    route {
        _ => {
            respond 200 {
                body: "Welcome to Pingclair! Default server active.";
            }
        }
    }
}
